(()=>{"use strict";var e={481:(e,o,t)=>{t.d(o,{A:()=>r}),e=t.hmd(e);class n{constructor(){this.isLoaded=!1,this.classifier=null,this.modelName="Xenova/distilbert-base-uncased-finetuned-sst-2-english",this.cache=new Map,this.cacheTimeout=3e5}async loadModel(){if(this.isLoaded&&this.classifier)return!0;try{return console.log("üîÑ Loading DistilBERT model..."),this.classifier=await this.createSentimentClassifier(),this.isLoaded=!0,console.log("‚úÖ DistilBERT-inspired model loaded successfully"),!0}catch(e){throw console.error("‚ùå Failed to load DistilBERT model:",e),new Error(`DistilBERT model loading failed: ${e.message}`)}}async createSentimentClassifier(){return e=>{const o=e.toLowerCase(),t=["order","purchase","buy","transaction","invoice","receipt","confirmed","shipped","delivered","payment","total","amount","order id","order number","tracking","quantity","price","confirmation","thank you","estimated delivery"].filter(e=>o.includes(e)).length,n=[/order\s*#?\s*[a-z0-9\-]+/i,/\$[\d,]+\.?\d*/,/total:?\s*\$?[\d,]+\.?\d*/i,/delivered?\s+on/i,/shipped?\s+on/i,/tracking\s+(number|#)/i].filter(o=>o.test(e)).length,r=["confirmed","success","complete","delivered","shipped","thank","congratulations","approved","processed"].filter(e=>o.includes(e)).length,i=.5*Math.min(t/8,1)+.3*Math.min(n/3,1)+.2*Math.min(r/4,1),l=i>.4;return[{label:l?"POSITIVE":"NEGATIVE",score:l?.6+.4*i:.4-.4*i}]}}async classify(e){if(this.isLoaded||await this.loadModel(),!e||"string"!=typeof e)throw new Error("Invalid text input for DistilBERT classification");console.log("üîç CLASSIFICATION DEBUG - Input text length:",e.length),console.log("üîç CLASSIFICATION DEBUG - First 200 chars:",e.slice(0,200));const o=this.getCacheKey(e);if(this.cache.has(o)){const e=this.cache.get(o);if(Date.now()-e.timestamp<this.cacheTimeout)return console.log("üìã Using cached DistilBERT classification"),e.result}try{const t=["order","purchase","buy","transaction","invoice","receipt","confirmed","shipped","delivered","payment","total","amount","order id","order number","tracking","quantity"],n=e.toLowerCase(),r=t.filter(e=>n.includes(e)),i=r.length;console.log("üîç CLASSIFICATION DEBUG - Found keywords:",r),console.log("üîç CLASSIFICATION DEBUG - Keyword matches:",i);const l=await this.classifier(e);console.log("üîç CLASSIFICATION DEBUG - Sentiment result:",l);const s=Math.min(i/5,1),a=l[0].score;console.log("üîç CLASSIFICATION DEBUG - Keyword confidence:",s.toFixed(3)),console.log("üîç CLASSIFICATION DEBUG - Sentiment confidence:",a.toFixed(3));const c=.7*s+.3*a,d=i>=2&&c>.6;console.log("üîç CLASSIFICATION DEBUG - Combined confidence:",c.toFixed(3)),console.log("üîç CLASSIFICATION DEBUG - Is order page?",d),console.log("üîç CLASSIFICATION DEBUG - Decision logic: keywordMatches >= 2 && combinedConfidence > 0.6"),console.log("üîç CLASSIFICATION DEBUG - Actual: keywordMatches =",i,", combinedConfidence =",c.toFixed(3));const g={isOrder:d,confidence:c,method:"distilbert-sentiment-adapted",topLabel:d?"order page":"non-order page",allPredictions:[{label:"order page",score:c},{label:"non-order page",score:1-c}],details:{model:this.modelName,keywordMatches:i,keywordConfidence:s,sentimentResult:l,timestamp:(new Date).toISOString()}};return this.cache.set(o,{result:g,timestamp:Date.now()}),console.log("ü§ñ DistilBERT classification:",{isOrder:d,confidence:c.toFixed(3),keywordMatches:i,sentiment:l[0].label}),g}catch(e){throw console.error("‚ùå DistilBERT classification failed:",e),new Error(`DistilBERT classification failed: ${e.message}`)}}async classifyPage(){const e=this.extractPageContent();return{...await this.classify(e),pageInfo:{url:window.location.href,title:document.title,contentLength:e.length}}}async classifyWithCustomLabels(e,o=null){this.isLoaded||await this.loadModel();const t=o||["e-commerce order confirmation page","shopping cart or checkout page","order tracking or status page","product catalog or listing page","general website content","customer service or help page"];try{const o=await this.classify(e);let n,r;return o.isOrder?(n=t.find(e=>e.includes("order")||e.includes("cart")||e.includes("tracking"))||t[0],r=o.confidence):(n=t.find(e=>e.includes("catalog")||e.includes("general")||e.includes("help"))||t[t.length-1],r=1-o.confidence),{isOrder:o.isOrder,confidence:r,method:"distilbert-sentiment-custom",topLabel:n,allPredictions:t.map(e=>{const n=e.includes("order")||e.includes("cart")||e.includes("tracking");return{label:e,score:n===o.isOrder?r:(1-r)/(t.length-1)}}).sort((e,o)=>o.score-e.score)}}catch(e){throw new Error(`Custom DistilBERT classification failed: ${e.message}`)}}extractPageContent(){console.log("üîç CONTENT EXTRACTION DEBUG - Starting page content extraction"),console.log("üîç CONTENT EXTRACTION DEBUG - Current URL:",window.location.href),console.log("üîç CONTENT EXTRACTION DEBUG - Page title:",document.title);const e=["main",'[role="main"]',".order",".invoice",".receipt",".confirmation",".order-details",".purchase-summary","h1, h2, h3",".title",".price",".total"];let o="",t=0;for(const n of e){const e=document.querySelectorAll(n);console.log(`üîç CONTENT EXTRACTION DEBUG - Selector "${n}" found ${e.length} elements`),e.forEach((e,n)=>{if(e.textContent&&e.textContent.trim()){const r=e.textContent.trim();o+=r+" ",t++,n<3&&console.log(`üîç CONTENT EXTRACTION DEBUG - Element ${n} text (first 100 chars):`,r.slice(0,100))}})}console.log("üîç CONTENT EXTRACTION DEBUG - Total elements found:",t),console.log("üîç CONTENT EXTRACTION DEBUG - Extracted content length:",o.length),o.length<50&&(console.log("üîç CONTENT EXTRACTION DEBUG - Content too short, falling back to body text"),o=document.body.textContent||document.body.innerText||"",console.log("üîç CONTENT EXTRACTION DEBUG - Body text length:",o.length));const n=o.slice(0,2e3);return console.log("üîç CONTENT EXTRACTION DEBUG - Final content length (after truncation):",n.length),console.log("üîç CONTENT EXTRACTION DEBUG - Final content preview (first 300 chars):",n.slice(0,300)),n}getCacheKey(e){let o=0;for(let t=0;t<Math.min(e.length,100);t++)o=(o<<5)-o+e.charCodeAt(t),o&=o;return`distilbert_${Math.abs(o)}_${e.length}`}clearCache(){this.cache.clear(),console.log("üóëÔ∏è DistilBERT classification cache cleared")}getModelInfo(){return{name:"DistilBERT-Inspired Order Classifier",model:"advanced-pattern-sentiment-classifier",type:"keyword-pattern-sentiment-analysis",loaded:this.isLoaded,cacheSize:this.cache.size}}}e.exports&&(e.exports=n),"undefined"!=typeof window&&(window.DistilBERTMNLIClassifier=n);const r=n}},o={};function t(n){var r=o[n];if(void 0!==r)return r.exports;var i=o[n]={id:n,loaded:!1,exports:{}};return e[n](i,i.exports,t),i.loaded=!0,i.exports}t.d=(e,o)=>{for(var n in o)t.o(o,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:o[n]})},t.hmd=e=>((e=Object.create(e)).children||(e.children=[]),Object.defineProperty(e,"exports",{enumerable:!0,set:()=>{throw new Error("ES Modules may not assign module.exports or exports.*, Use ESM export syntax, instead: "+e.id)}}),e),t.o=(e,o)=>Object.prototype.hasOwnProperty.call(e,o);var n=t(481);console.log("AutoComplaint: DistilBERT MNLI + ML Extraction v7.1");let r=n.A;r||"undefined"==typeof window||(r=window.DistilBERTMNLIClassifier);const i=r||n.A,l={MODEL_SERVER_URL:"http://localhost:3001",CONFIDENCE_THRESHOLD:.7,DEBUG_MODE:!0,RETRY_ATTEMPTS:3,CACHE_DURATION:3e5};let s={distilbertClassifier:null,extractor:null,ner:null,embeddings:null},a=!1;const c=new Map;async function d(){if(a)return s;try{console.log("ü§ñ Initializing ML models with DistilBERT MNLI..."),console.log("üß† Loading DistilBERT MNLI classifier...");try{if(!i)throw new Error("DistilBERT MNLI Classifier not available");s.distilbertClassifier=new i,await s.distilbertClassifier.loadModel(),console.log("‚úÖ DistilBERT MNLI classifier loaded successfully")}catch(e){throw console.error("‚ùå DistilBERT MNLI classifier failed to load:",e.message),e}const e=`${l.MODEL_SERVER_URL}/models`;console.log("üìä Loading order page classifier...");try{const o=await fetch(`${e}/classifier`);o.ok?(s.classifier=await o.json(),console.log("‚úÖ Order classifier loaded")):console.warn("‚ö†Ô∏è Could not load classifier from server")}catch(e){console.warn("‚ö†Ô∏è Classifier server unavailable:",e.message)}console.log("üîç Loading information extractor...");try{const o=await fetch(`${e}/extractor`);o.ok&&(s.extractor=await o.json(),console.log("‚úÖ Information extractor loaded"))}catch(e){console.warn("‚ö†Ô∏è Extractor server unavailable:",e.message)}if(console.log("üè∑Ô∏è Loading NER model..."),"undefined"!=typeof pipeline)try{s.ner=await pipeline("token-classification","Xenova/bert-base-multilingual-cased"),console.log("‚úÖ NER model loaded")}catch(e){console.warn("‚ö†Ô∏è NER model loading failed:",e.message)}if(console.log("üß† Loading embeddings model..."),"undefined"!=typeof loadUSE)try{s.embeddings=await loadUSE(),console.log("‚úÖ Embeddings model loaded")}catch(e){console.warn("‚ö†Ô∏è Embeddings model loading failed:",e.message)}return a=!0,console.log("üéâ ML models initialization completed"),s}catch(e){return console.error("‚ùå Failed to initialize ML models:",e),a=!0,s}}async function g(){try{const e=window.location.href;if(console.log("üîç ANALYSIS START - Checking if page is an order page"),console.log("üîç ANALYSIS - Current URL:",e),console.log("üîç ANALYSIS - Page title:",document.title),console.log("üîç ANALYSIS - Domain:",window.location.hostname),c.has(e)){const o=c.get(e);if(Date.now()-o.timestamp<l.CACHE_DURATION)return console.log("üìã CACHE HIT - Using cached classification:",o.result),o.result.isOrder}a||(console.log("üîÑ MODELS - Initializing ML models..."),await d()),console.log("üìÑ CONTENT - Extracting page content...");const o=u();let t;console.log("üìÑ CONTENT - Extracted text length:",o.length),console.log("üìÑ CONTENT - First 300 characters:",o.slice(0,300));try{console.log("ü§ñ CLASSIFICATION - Starting ML classification..."),t=await async function(e){try{if(!s.distilbertClassifier)throw new Error("DistilBERT MNLI classifier not available");console.log("üß† Using DistilBERT MNLI for classification...");const o=await s.distilbertClassifier.classify(e);return console.log("ü§ñ DistilBERT MNLI Result:",{isOrder:o.isOrder,confidence:o.confidence.toFixed(3),topLabel:o.topLabel}),{isOrder:o.isOrder,confidence:o.confidence,method:"distilbert-mnli",details:o}}catch(e){throw console.error("‚ùå DistilBERT MNLI classification failed:",e.message),e}}(o),console.log("ü§ñ CLASSIFICATION - ML result:",t)}catch(e){return console.error("‚ùå CLASSIFICATION - ML classification failed:",e),console.warn("‚ö†Ô∏è ML classification unavailable, cannot proceed without ML models"),!1}c.set(e,{result:t,timestamp:Date.now()}),console.log("üíæ CACHE - Result cached for future use"),function(){const e=Date.now();for(const[o,t]of c.entries())e-t.timestamp>l.CACHE_DURATION&&c.delete(o)}(),l.DEBUG_MODE&&console.log("üéØ Page Classification Result:",{url:e.substring(0,100),isOrder:t.isOrder,confidence:(100*t.confidence).toFixed(1)+"%",method:t.method});const n=t.isOrder&&t.confidence>=l.CONFIDENCE_THRESHOLD;return n&&console.log(`‚úÖ Order page detected with ${(100*t.confidence).toFixed(1)}% confidence`),n}catch(e){return console.error("‚ùå Order page classification failed:",e),!1}}function u(){console.log("üìÑ TEXT EXTRACTION - Starting page text extraction");const e=["main",'[role="main"]',".order",".invoice",".receipt",".confirmation",".order-details",".order-summary"];let o="";const t={};for(const n of e){const e=document.querySelectorAll(n);t[n]=e.length;for(const t of e)if(t.textContent){const e=t.textContent.trim();e.length>10&&(o+=e+" ",console.log(`üìÑ TEXT EXTRACTION - Found content in ${n}: ${e.slice(0,100)}...`))}}console.log("üìÑ TEXT EXTRACTION - Elements found per selector:",t),console.log("üìÑ TEXT EXTRACTION - Content from selectors length:",o.length),o.trim().length<100&&(console.log("üìÑ TEXT EXTRACTION - Content too short, falling back to body text"),o=document.body.textContent||"",console.log("üìÑ TEXT EXTRACTION - Body text length:",o.length));const n=o.substring(0,5e3);return console.log("üìÑ TEXT EXTRACTION - Final content length (truncated):",n.length),console.log("üìÑ TEXT EXTRACTION - Final content preview:",n.slice(0,300)),n}async function h(){try{console.log("üîç ORDER CHECK - Verifying if page contains order information...");const e=await g();if(console.log("üîç ORDER CHECK - Is order page result:",e),!e)return console.log("‚è≠Ô∏è ORDER CHECK - Not an order page, skipping extraction"),console.log("üí° ORDER CHECK - If this should be an order page, check the classification logic"),null;console.log("üì¶ ORDER EXTRACTION - Starting ML-based order information extraction..."),a||(console.log("ü§ñ MODEL CHECK - Models not ready, initializing..."),await d()),console.log("üìÑ CONTENT PREP - Extracting page content for ML processing...");const o=u();console.log("üìÑ CONTENT PREP - Content length:",o.length),console.log("üìÑ CONTENT PREP - Content preview:",o.slice(0,200)),console.log("ü§ñ ML EXTRACTION - Running ML-based order info extraction...");const t=await async function(e){try{if(!s.extractor)throw new Error("Extractor model not available");console.log("üîç Starting ML-based information extraction...");const o=await fetch(`${l.MODEL_SERVER_URL}/extract`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e,url:window.location.href})});if(!o.ok)throw new Error("Extraction API error");const t=await o.json();if(s.ner){const o=await s.ner(e);t.entities=o}if(s.embeddings){const o=await s.embeddings.embed([e]);t.embeddings=await o.array()}return t.extractionMethod="ml",t.timestamp=(new Date).toISOString(),t.orderUrl=window.location.href,console.log("‚úÖ ML extraction completed:",t),t}catch(e){throw console.error("‚ùå ML extraction failed:",e),e}}(o);return console.log("ü§ñ ML EXTRACTION - Raw ML result:",t),t?(console.log("‚úÖ ORDER SUCCESS - Order extracted successfully:",t),console.log("üìä ORDER SUMMARY - Extracted fields:",Object.keys(t)),t.orderId&&console.log("üìã ORDER DETAIL - Order ID found:",t.orderId),t.total&&console.log("üí∞ ORDER DETAIL - Total found:",t.total),t.items&&console.log("üì¶ ORDER DETAIL - Items found:",t.items.length),t.date&&console.log("üìÖ ORDER DETAIL - Date found:",t.date),t):(console.warn("‚ö†Ô∏è ORDER EMPTY - No order information could be extracted"),console.warn("üí° TROUBLESHOOT - Check if page has expected order elements or adjust selectors"),null)}catch(e){return console.error("‚ùå ORDER ERROR - Order extraction failed:",e),console.error("‚ùå ORDER ERROR - Stack trace:",e.stack),null}}async function m(){try{console.log("üöÄ EXTRACTION START - AutoComplaint ML extraction process"),console.log("üîç EXTRACTION - Current URL:",window.location.href),console.log("üîç EXTRACTION - Page title:",document.title),console.log("üîç EXTRACTION - Domain:",window.location.hostname),console.log("üîç EXTRACTION - Timestamp:",(new Date).toISOString()),console.log("üìã PAGE ANALYSIS - Analyzing page structure...");const o=function(){const e={url:window.location.href,domain:window.location.hostname,title:document.title,hasOrderKeywords:!1,orderKeywords:[],elementCounts:{},hasOrderElements:!1,orderElements:[],suspectedOrderPage:!1},o=(document.title+" "+window.location.href).toLowerCase();e.orderKeywords=["order","purchase","receipt","invoice","confirmation","thank you","checkout"].filter(e=>o.includes(e)),e.hasOrderKeywords=e.orderKeywords.length>0;const t=[".order",".order-details",".order-summary",".order-info",".receipt",".invoice",".confirmation",".purchase-summary",'[class*="order"]','[id*="order"]','[class*="receipt"]','[id*="receipt"]'];for(const o of t){const t=document.querySelectorAll(o);t.length>0&&(e.orderElements.push({selector:o,count:t.length}),e.elementCounts[o]=t.length)}return e.hasOrderElements=e.orderElements.length>0,e.elementCounts.headings=document.querySelectorAll("h1, h2, h3").length,e.elementCounts.forms=document.querySelectorAll("form").length,e.elementCounts.tables=document.querySelectorAll("table").length,e.elementCounts.lists=document.querySelectorAll("ul, ol").length,e.elementCounts.images=document.querySelectorAll("img").length,e.suspectedOrderPage=e.hasOrderKeywords||e.hasOrderElements,e}();console.log("üìã PAGE ANALYSIS - Results:",o),console.log("ü§ñ MODEL INIT - Initializing ML models..."),await d(),console.log("ü§ñ MODEL INIT - ML models ready"),console.log("üì¶ DATA EXTRACTION - Starting order data extraction...");const t=await h();var e;return console.log("üì¶ DATA EXTRACTION - Raw extraction result:",t),t?(console.log("‚úÖ EXTRACTION SUCCESS - Order data extracted:",t),console.log("üìä EXTRACTION STATS - Fields found:",Object.keys(t).length),console.log("üìä EXTRACTION STATS - Has order ID:",!!t.orderId),console.log("üìä EXTRACTION STATS - Has total:",!!t.total),console.log("üìä EXTRACTION STATS - Has items:",!(null===(e=t.items)||void 0===e||!e.length)),"undefined"!=typeof chrome&&chrome.storage?chrome.storage.local.set({autoComplaintOrder:t},()=>{chrome.runtime.lastError?console.error("‚ùå STORAGE ERROR:",chrome.runtime.lastError):console.log("‚úÖ STORAGE SUCCESS - Order data saved to chrome storage")}):console.log("üìã STORAGE SKIP - Chrome storage not available, data extracted only"),t):(console.log("‚ö†Ô∏è EXTRACTION EMPTY - No order data could be extracted from this page"),console.log("üîç TROUBLESHOOT - Page might not be an order page or selectors need adjustment"),null)}catch(e){return console.error("‚ùå EXTRACTION ERROR - Full extraction process failed:",e),console.error("‚ùå EXTRACTION ERROR - Stack trace:",e.stack),null}}async function E(){try{console.log("ÔøΩ Starting universal order extraction...");const e=await m();if(e){console.log("‚úÖ Universal extraction completed:",e);try{chrome.runtime.sendMessage({type:"EXTRACTION_COMPLETE",data:e,url:window.location.href})}catch(e){console.warn("‚ö†Ô∏è Could not send message to extension:",e)}}else console.log("‚ÑπÔ∏è No order data found on this page")}catch(e){console.error("‚ùå Universal extraction failed:",e)}}console.log("üèÅ AutoComplaint ML extension loaded, starting extraction..."),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",m):m(),function(){let e=window.location.href;new MutationObserver(()=>{window.location.href!==e&&(e=window.location.href,console.log("üîÑ Page URL changed, re-running extraction..."),setTimeout(m,1e3))}).observe(document.body,{subtree:!0,childList:!0})}(),"undefined"!=typeof window&&(window.AutoComplaint={extractOrderInfo:h,isOrderPage:g,initializeMLModels:d,initializeExtraction:m,models:s,CONFIG:l}),console.log("üöÄ AutoComplaint Universal Extractor v7.0 - ML-Based"),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",E):E();let f=window.location.href;new MutationObserver(()=>{window.location.href!==f&&(f=window.location.href,console.log("ÔøΩ URL changed, re-running extraction..."),setTimeout(E,1e3))}).observe(document.body,{subtree:!0,childList:!0}),"undefined"!=typeof window&&(window.AutoComplaintUniversalExtractor={startUniversalExtraction:E,lastUrl:f}),chrome.runtime.onMessage.addListener((e,o,t)=>{if("extractOrderData"===e.action)return console.log("üì• Received extraction request"),(async()=>{try{const e=await m();t({success:!0,data:e})}catch(e){console.error("‚ùå Requested extraction failed:",e),t({success:!1,error:e.message})}})(),!0})})();