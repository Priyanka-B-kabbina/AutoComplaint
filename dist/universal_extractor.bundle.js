(()=>{"use strict";var e={481:(e,o,t)=>{t.d(o,{A:()=>n}),e=t.hmd(e);class i{constructor(){this.isLoaded=!1,this.classifier=null,this.modelName="Xenova/distilbert-base-uncased-finetuned-sst-2-english",this.cache=new Map,this.cacheTimeout=3e5}async loadModel(){if(this.isLoaded&&this.classifier)return!0;try{if(console.log("üîÑ Loading DistilBERT model..."),void 0===window.pipeline&&await this.loadTransformersLibrary(),void 0===window.pipeline)throw new Error("Pipeline function not available. Make sure @xenova/transformers is loaded.");return this.classifier=await window.pipeline("sentiment-analysis",this.modelName),this.isLoaded=!0,console.log("‚úÖ DistilBERT model loaded successfully"),!0}catch(e){throw console.error("‚ùå Failed to load DistilBERT model:",e),new Error(`DistilBERT model loading failed: ${e.message}`)}}async loadTransformersLibrary(){if(void 0===window.pipeline)return console.log("üì¶ Loading @xenova/transformers library..."),new Promise((e,o)=>{const t=document.createElement("script");t.type="module",t.textContent="\n        import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';\n        window.pipeline = pipeline;\n        window.transformersLoaded = true;\n      ",t.onload=()=>{const o=()=>{window.transformersLoaded?(console.log("‚úÖ Transformers library loaded successfully"),e()):setTimeout(o,100)};o()},t.onerror=()=>{o(new Error("Failed to load transformers library"))},document.head.appendChild(t)})}async classify(e){if(this.isLoaded||await this.loadModel(),!e||"string"!=typeof e)throw new Error("Invalid text input for DistilBERT classification");const o=this.getCacheKey(e);if(this.cache.has(o)){const e=this.cache.get(o);if(Date.now()-e.timestamp<this.cacheTimeout)return console.log("üìã Using cached DistilBERT classification"),e.result}try{const t=["order","purchase","buy","transaction","invoice","receipt","confirmed","shipped","delivered","payment","total","amount","order id","order number","tracking","quantity"],i=e.toLowerCase(),n=t.filter(e=>i.includes(e)).length,r=await this.classifier(e),a=Math.min(n/5,1),s=.7*a+.3*r[0].score,l=n>=2&&s>.6,c={isOrder:l,confidence:s,method:"distilbert-sentiment-adapted",topLabel:l?"order page":"non-order page",allPredictions:[{label:"order page",score:s},{label:"non-order page",score:1-s}],details:{model:this.modelName,keywordMatches:n,keywordConfidence:a,sentimentResult:r,timestamp:(new Date).toISOString()}};return this.cache.set(o,{result:c,timestamp:Date.now()}),console.log("ü§ñ DistilBERT classification:",{isOrder:l,confidence:s.toFixed(3),keywordMatches:n,sentiment:r[0].label}),c}catch(e){throw console.error("‚ùå DistilBERT classification failed:",e),new Error(`DistilBERT classification failed: ${e.message}`)}}async classifyPage(){try{const e=this.extractPageContent();if(!e||e.trim().length<50)throw new Error("Insufficient page content for DistilBERT classification");const o=await this.classify(e);return o.pageInfo={contentLength:e.length,url:window.location.href,title:document.title,timestamp:(new Date).toISOString(),modelUsed:"DistilBERT MNLI"},o}catch(e){throw console.error("‚ùå DistilBERT page classification error:",e),e}}async classifyWithCustomLabels(e,o=null){this.isLoaded||await this.loadModel();const t=o||["e-commerce order confirmation page","shopping cart or checkout page","order tracking or status page","product catalog or listing page","general website content","customer service or help page"];try{const o=await this.classify(e);let i,n;return o.isOrder?(i=t.find(e=>e.includes("order")||e.includes("cart")||e.includes("tracking"))||t[0],n=o.confidence):(i=t.find(e=>e.includes("catalog")||e.includes("general")||e.includes("help"))||t[t.length-1],n=1-o.confidence),{isOrder:o.isOrder,confidence:n,method:"distilbert-sentiment-custom",topLabel:i,allPredictions:t.map(e=>{const i=e.includes("order")||e.includes("cart")||e.includes("tracking");return{label:e,score:i===o.isOrder?n:(1-n)/(t.length-1)}}).sort((e,o)=>o.score-e.score)}}catch(e){throw new Error(`Custom DistilBERT classification failed: ${e.message}`)}}extractPageContent(){const e=["main",'[role="main"]',".order",".invoice",".receipt",".confirmation",".order-details",".order-summary","h1, h2, h3",".title",".heading",".product-title",".checkout",".cart"];let o="";for(const t of e){const e=document.querySelectorAll(t);for(const t of e)t.textContent&&(o+=t.textContent+" ")}return o.trim().length<100&&(o=document.body.textContent||""),o.substring(0,2e3)}getCacheKey(e){let o=0;for(let t=0;t<Math.min(e.length,100);t++)o=(o<<5)-o+e.charCodeAt(t),o&=o;return`distilbert_${Math.abs(o)}_${e.length}`}clearCache(){this.cache.clear(),console.log("üóëÔ∏è DistilBERT classification cache cleared")}getModelInfo(){return{name:"DistilBERT Order Classifier",model:this.modelName,type:"sentiment-analysis-adapted",loaded:this.isLoaded,cacheSize:this.cache.size}}}e.exports&&(e.exports=i),"undefined"!=typeof window&&(window.DistilBERTMNLIClassifier=i);const n=i}},o={};function t(i){var n=o[i];if(void 0!==n)return n.exports;var r=o[i]={id:i,loaded:!1,exports:{}};return e[i](r,r.exports,t),r.loaded=!0,r.exports}t.d=(e,o)=>{for(var i in o)t.o(o,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:o[i]})},t.hmd=e=>((e=Object.create(e)).children||(e.children=[]),Object.defineProperty(e,"exports",{enumerable:!0,set:()=>{throw new Error("ES Modules may not assign module.exports or exports.*, Use ESM export syntax, instead: "+e.id)}}),e),t.o=(e,o)=>Object.prototype.hasOwnProperty.call(e,o);var i=t(481);console.log("AutoComplaint: DistilBERT MNLI + ML Extraction v7.1");let n=i.A;n||"undefined"==typeof window||(n=window.DistilBERTMNLIClassifier);const r=n||i.A,a={MODEL_SERVER_URL:"http://localhost:3001",CONFIDENCE_THRESHOLD:.7,DEBUG_MODE:!0,RETRY_ATTEMPTS:3,CACHE_DURATION:3e5};let s={distilbertClassifier:null,extractor:null,ner:null,embeddings:null},l=!1;const c=new Map;async function d(){if(l)return s;try{console.log("ü§ñ Initializing ML models with DistilBERT MNLI..."),console.log("üß† Loading DistilBERT MNLI classifier...");try{if(!r)throw new Error("DistilBERT MNLI Classifier not available");s.distilbertClassifier=new r,await s.distilbertClassifier.loadModel(),console.log("‚úÖ DistilBERT MNLI classifier loaded successfully")}catch(e){throw console.error("‚ùå DistilBERT MNLI classifier failed to load:",e.message),e}const e=`${a.MODEL_SERVER_URL}/models`;console.log("üìä Loading order page classifier...");try{const o=await fetch(`${e}/classifier`);o.ok?(s.classifier=await o.json(),console.log("‚úÖ Order classifier loaded")):console.warn("‚ö†Ô∏è Could not load classifier from server")}catch(e){console.warn("‚ö†Ô∏è Classifier server unavailable:",e.message)}console.log("üîç Loading information extractor...");try{const o=await fetch(`${e}/extractor`);o.ok&&(s.extractor=await o.json(),console.log("‚úÖ Information extractor loaded"))}catch(e){console.warn("‚ö†Ô∏è Extractor server unavailable:",e.message)}if(console.log("üè∑Ô∏è Loading NER model..."),"undefined"!=typeof pipeline)try{s.ner=await pipeline("token-classification","Xenova/bert-base-multilingual-cased"),console.log("‚úÖ NER model loaded")}catch(e){console.warn("‚ö†Ô∏è NER model loading failed:",e.message)}if(console.log("üß† Loading embeddings model..."),"undefined"!=typeof loadUSE)try{s.embeddings=await loadUSE(),console.log("‚úÖ Embeddings model loaded")}catch(e){console.warn("‚ö†Ô∏è Embeddings model loading failed:",e.message)}return l=!0,console.log("üéâ ML models initialization completed"),s}catch(e){return console.error("‚ùå Failed to initialize ML models:",e),l=!0,s}}async function f(){try{const e=window.location.href;if(c.has(e)){const o=c.get(e);if(Date.now()-o.timestamp<a.CACHE_DURATION)return a.DEBUG_MODE&&console.log("üìã Using cached classification:",o.result),o.result.isOrder}l||await d();const o=u();let t;try{t=await async function(e){try{if(!s.distilbertClassifier)throw new Error("DistilBERT MNLI classifier not available");console.log("üß† Using DistilBERT MNLI for classification...");const o=await s.distilbertClassifier.classify(e);return console.log("ü§ñ DistilBERT MNLI Result:",{isOrder:o.isOrder,confidence:o.confidence.toFixed(3),topLabel:o.topLabel}),{isOrder:o.isOrder,confidence:o.confidence,method:"distilbert-mnli",details:o}}catch(e){throw console.error("‚ùå DistilBERT MNLI classification failed:",e.message),e}}(o)}catch(e){return console.warn("‚ö†Ô∏è ML classification unavailable, cannot proceed without ML models"),!1}c.set(e,{result:t,timestamp:Date.now()}),function(){const e=Date.now();for(const[o,t]of c.entries())e-t.timestamp>a.CACHE_DURATION&&c.delete(o)}(),a.DEBUG_MODE&&console.log("üéØ Page Classification Result:",{url:e.substring(0,100),isOrder:t.isOrder,confidence:(100*t.confidence).toFixed(1)+"%",method:t.method});const i=t.isOrder&&t.confidence>=a.CONFIDENCE_THRESHOLD;return i&&console.log(`‚úÖ Order page detected with ${(100*t.confidence).toFixed(1)}% confidence`),i}catch(e){return console.error("‚ùå Order page classification failed:",e),!1}}function u(){const e=["main",'[role="main"]',".order",".invoice",".receipt",".confirmation",".order-details",".order-summary"];let o="";for(const t of e){const e=document.querySelectorAll(t);for(const t of e)t.textContent&&(o+=t.textContent+" ")}return o.trim().length<100&&(o=document.body.textContent||""),o.substring(0,5e3)}async function m(){try{if(!await f())return console.log("‚è≠Ô∏è Not an order page, skipping extraction"),null;console.log("üì¶ Extracting order information with ML..."),l||await d();const e=u(),o=await async function(e){try{if(!s.extractor)throw new Error("Extractor model not available");console.log("üîç Starting ML-based information extraction...");const o=await fetch(`${a.MODEL_SERVER_URL}/extract`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e,url:window.location.href})});if(!o.ok)throw new Error("Extraction API error");const t=await o.json();if(s.ner){const o=await s.ner(e);t.entities=o}if(s.embeddings){const o=await s.embeddings.embed([e]);t.embeddings=await o.array()}return t.extractionMethod="ml",t.timestamp=(new Date).toISOString(),t.orderUrl=window.location.href,console.log("‚úÖ ML extraction completed:",t),t}catch(e){throw console.error("‚ùå ML extraction failed:",e),e}}(e);return o?(console.log("‚úÖ Order extracted successfully:",o),o):(console.warn("‚ö†Ô∏è No order information could be extracted"),null)}catch(e){return console.error("‚ùå Order extraction failed:",e),null}}async function h(){try{console.log("üöÄ Starting AutoComplaint ML extraction process..."),await d();const e=await m();return e?(console.log("üì¶ Successfully extracted order data:",e),"undefined"!=typeof chrome&&chrome.storage?chrome.storage.local.set({autoComplaintOrder:e},()=>{chrome.runtime.lastError?console.error("‚ùå Storage error:",chrome.runtime.lastError):console.log("‚úÖ Order data saved to storage")}):console.log("üìã Order data extracted (no storage available):",e),e):(console.log("‚ö†Ô∏è No order data could be extracted from this page"),null)}catch(e){return console.error("‚ùå Extraction process failed:",e),null}}async function g(){try{console.log("ÔøΩ Starting universal order extraction...");const e=await h();if(e){console.log("‚úÖ Universal extraction completed:",e);try{chrome.runtime.sendMessage({type:"EXTRACTION_COMPLETE",data:e,url:window.location.href})}catch(e){console.warn("‚ö†Ô∏è Could not send message to extension:",e)}}else console.log("‚ÑπÔ∏è No order data found on this page")}catch(e){console.error("‚ùå Universal extraction failed:",e)}}console.log("üèÅ AutoComplaint ML extension loaded, starting extraction..."),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",h):h(),function(){let e=window.location.href;new MutationObserver(()=>{window.location.href!==e&&(e=window.location.href,console.log("üîÑ Page URL changed, re-running extraction..."),setTimeout(h,1e3))}).observe(document.body,{subtree:!0,childList:!0})}(),"undefined"!=typeof window&&(window.AutoComplaint={extractOrderInfo:m,isOrderPage:f,initializeMLModels:d,initializeExtraction:h,models:s,CONFIG:a}),console.log("üöÄ AutoComplaint Universal Extractor v7.0 - ML-Based"),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",g):g();let w=window.location.href;new MutationObserver(()=>{window.location.href!==w&&(w=window.location.href,console.log("ÔøΩ URL changed, re-running extraction..."),setTimeout(g,1e3))}).observe(document.body,{subtree:!0,childList:!0}),"undefined"!=typeof window&&(window.AutoComplaintUniversalExtractor={startUniversalExtraction:g,lastUrl:w}),chrome.runtime.onMessage.addListener((e,o,t)=>{if("extractOrderData"===e.action)return console.log("üì• Received extraction request"),(async()=>{try{const e=await h();t({success:!0,data:e})}catch(e){console.error("‚ùå Requested extraction failed:",e),t({success:!1,error:e.message})}})(),!0})})();