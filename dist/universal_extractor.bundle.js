(()=>{"use strict";var e,t,o={481:(e,t,o)=>{o.d(t,{A:()=>n}),e=o.hmd(e);class i{constructor(){this.isLoaded=!1,this.classifier=null,this.modelName="Xenova/distilbert-base-uncased-finetuned-sst-2-english",this.cache=new Map,this.cacheTimeout=3e5}async loadModel(){if(this.isLoaded&&this.classifier)return!0;try{let e;if(console.log("üîÑ Loading DistilBERT model..."),"undefined"!=typeof window&&window.pipeline)e=window.pipeline;else{const{pipeline:t}=await o.e(365).then(o.bind(o,365));e=t,"undefined"!=typeof window&&(window.pipeline=e)}return this.classifier=await e("sentiment-analysis",this.modelName),this.isLoaded=!0,console.log("‚úÖ DistilBERT model loaded successfully"),!0}catch(e){throw console.error("‚ùå Failed to load DistilBERT model:",e),new Error(`DistilBERT model loading failed: ${e.message}`)}}async classify(e){if(this.isLoaded||await this.loadModel(),!e||"string"!=typeof e)throw new Error("Invalid text input for DistilBERT classification");const t=this.getCacheKey(e);if(this.cache.has(t)){const e=this.cache.get(t);if(Date.now()-e.timestamp<this.cacheTimeout)return console.log("üìã Using cached DistilBERT classification"),e.result}try{const o=["order","purchase","buy","transaction","invoice","receipt","confirmed","shipped","delivered","payment","total","amount","order id","order number","tracking","quantity"],i=e.toLowerCase(),n=o.filter(e=>i.includes(e)).length,r=await this.classifier(e),a=Math.min(n/5,1),s=.7*a+.3*r[0].score,l=n>=2&&s>.6,c={isOrder:l,confidence:s,method:"distilbert-sentiment-adapted",topLabel:l?"order page":"non-order page",allPredictions:[{label:"order page",score:s},{label:"non-order page",score:1-s}],details:{model:this.modelName,keywordMatches:n,keywordConfidence:a,sentimentResult:r,timestamp:(new Date).toISOString()}};return this.cache.set(t,{result:c,timestamp:Date.now()}),console.log("ü§ñ DistilBERT classification:",{isOrder:l,confidence:s.toFixed(3),keywordMatches:n,sentiment:r[0].label}),c}catch(e){throw console.error("‚ùå DistilBERT classification failed:",e),new Error(`DistilBERT classification failed: ${e.message}`)}}async classifyPage(){const e=this.extractPageContent();return{...await this.classify(e),pageInfo:{url:window.location.href,title:document.title,contentLength:e.length}}}async classifyWithCustomLabels(e,t=null){this.isLoaded||await this.loadModel();const o=t||["e-commerce order confirmation page","shopping cart or checkout page","order tracking or status page","product catalog or listing page","general website content","customer service or help page"];try{const t=await this.classify(e);let i,n;return t.isOrder?(i=o.find(e=>e.includes("order")||e.includes("cart")||e.includes("tracking"))||o[0],n=t.confidence):(i=o.find(e=>e.includes("catalog")||e.includes("general")||e.includes("help"))||o[o.length-1],n=1-t.confidence),{isOrder:t.isOrder,confidence:n,method:"distilbert-sentiment-custom",topLabel:i,allPredictions:o.map(e=>{const i=e.includes("order")||e.includes("cart")||e.includes("tracking");return{label:e,score:i===t.isOrder?n:(1-n)/(o.length-1)}}).sort((e,t)=>t.score-e.score)}}catch(e){throw new Error(`Custom DistilBERT classification failed: ${e.message}`)}}extractPageContent(){const e=["main",'[role="main"]',".order",".invoice",".receipt",".confirmation",".order-details",".purchase-summary","h1, h2, h3",".title",".price",".total"];let t="";for(const o of e)document.querySelectorAll(o).forEach(e=>{e.textContent&&(t+=e.textContent.trim()+" ")});return t.length<50&&(t=document.body.textContent||document.body.innerText||""),t.slice(0,2e3)}getCacheKey(e){let t=0;for(let o=0;o<Math.min(e.length,100);o++)t=(t<<5)-t+e.charCodeAt(o),t&=t;return`distilbert_${Math.abs(t)}_${e.length}`}clearCache(){this.cache.clear(),console.log("üóëÔ∏è DistilBERT classification cache cleared")}getModelInfo(){return{name:"DistilBERT Order Classifier",model:this.modelName,type:"sentiment-analysis-transformers",loaded:this.isLoaded,cacheSize:this.cache.size}}}e.exports&&(e.exports=i),"undefined"!=typeof window&&(window.DistilBERTMNLIClassifier=i);const n=i}},i={};function n(e){var t=i[e];if(void 0!==t)return t.exports;var r=i[e]={id:e,loaded:!1,exports:{}};return o[e](r,r.exports,n),r.loaded=!0,r.exports}n.m=o,n.d=(e,t)=>{for(var o in t)n.o(t,o)&&!n.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},n.f={},n.e=e=>Promise.all(Object.keys(n.f).reduce((t,o)=>(n.f[o](e,t),t),[])),n.u=e=>e+".bundle.js",n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.hmd=e=>((e=Object.create(e)).children||(e.children=[]),Object.defineProperty(e,"exports",{enumerable:!0,set:()=>{throw new Error("ES Modules may not assign module.exports or exports.*, Use ESM export syntax, instead: "+e.id)}}),e),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},t="autocomplaint-extension:",n.l=(o,i,r,a)=>{if(e[o])e[o].push(i);else{var s,l;if(void 0!==r)for(var c=document.getElementsByTagName("script"),d=0;d<c.length;d++){var u=c[d];if(u.getAttribute("src")==o||u.getAttribute("data-webpack")==t+r){s=u;break}}s||(l=!0,(s=document.createElement("script")).charset="utf-8",s.timeout=120,n.nc&&s.setAttribute("nonce",n.nc),s.setAttribute("data-webpack",t+r),s.src=o),e[o]=[i];var f=(t,i)=>{s.onerror=s.onload=null,clearTimeout(m);var n=e[o];if(delete e[o],s.parentNode&&s.parentNode.removeChild(s),n&&n.forEach(e=>e(i)),t)return t(i)},m=setTimeout(f.bind(null,void 0,{type:"timeout",target:s}),12e4);s.onerror=f.bind(null,s.onerror),s.onload=f.bind(null,s.onload),l&&document.head.appendChild(s)}},(()=>{var e;n.g.importScripts&&(e=n.g.location+"");var t=n.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var o=t.getElementsByTagName("script");if(o.length)for(var i=o.length-1;i>-1&&(!e||!/^http(s?):/.test(e));)e=o[i--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),n.p=e})(),(()=>{var e={67:0,947:0};n.f.j=(t,o)=>{var i=n.o(e,t)?e[t]:void 0;if(0!==i)if(i)o.push(i[2]);else{var r=new Promise((o,n)=>i=e[t]=[o,n]);o.push(i[2]=r);var a=n.p+n.u(t),s=new Error;n.l(a,o=>{if(n.o(e,t)&&(0!==(i=e[t])&&(e[t]=void 0),i)){var r=o&&("load"===o.type?"missing":o.type),a=o&&o.target&&o.target.src;s.message="Loading chunk "+t+" failed.\n("+r+": "+a+")",s.name="ChunkLoadError",s.type=r,s.request=a,i[1](s)}},"chunk-"+t,t)}};var t=(t,o)=>{var i,r,[a,s,l]=o,c=0;if(a.some(t=>0!==e[t])){for(i in s)n.o(s,i)&&(n.m[i]=s[i]);l&&l(n)}for(t&&t(o);c<a.length;c++)r=a[c],n.o(e,r)&&e[r]&&e[r][0](),e[r]=0},o=self.webpackChunkautocomplaint_extension=self.webpackChunkautocomplaint_extension||[];o.forEach(t.bind(null,0)),o.push=t.bind(null,o.push.bind(o))})();var r=n(481);console.log("AutoComplaint: DistilBERT MNLI + ML Extraction v7.1");let a=r.A;a||"undefined"==typeof window||(a=window.DistilBERTMNLIClassifier);const s=a||r.A,l={MODEL_SERVER_URL:"http://localhost:3001",CONFIDENCE_THRESHOLD:.7,DEBUG_MODE:!0,RETRY_ATTEMPTS:3,CACHE_DURATION:3e5};let c={distilbertClassifier:null,extractor:null,ner:null,embeddings:null},d=!1;const u=new Map;async function f(){if(d)return c;try{console.log("ü§ñ Initializing ML models with DistilBERT MNLI..."),console.log("üß† Loading DistilBERT MNLI classifier...");try{if(!s)throw new Error("DistilBERT MNLI Classifier not available");c.distilbertClassifier=new s,await c.distilbertClassifier.loadModel(),console.log("‚úÖ DistilBERT MNLI classifier loaded successfully")}catch(e){throw console.error("‚ùå DistilBERT MNLI classifier failed to load:",e.message),e}const e=`${l.MODEL_SERVER_URL}/models`;console.log("üìä Loading order page classifier...");try{const t=await fetch(`${e}/classifier`);t.ok?(c.classifier=await t.json(),console.log("‚úÖ Order classifier loaded")):console.warn("‚ö†Ô∏è Could not load classifier from server")}catch(e){console.warn("‚ö†Ô∏è Classifier server unavailable:",e.message)}console.log("üîç Loading information extractor...");try{const t=await fetch(`${e}/extractor`);t.ok&&(c.extractor=await t.json(),console.log("‚úÖ Information extractor loaded"))}catch(e){console.warn("‚ö†Ô∏è Extractor server unavailable:",e.message)}if(console.log("üè∑Ô∏è Loading NER model..."),"undefined"!=typeof pipeline)try{c.ner=await pipeline("token-classification","Xenova/bert-base-multilingual-cased"),console.log("‚úÖ NER model loaded")}catch(e){console.warn("‚ö†Ô∏è NER model loading failed:",e.message)}if(console.log("üß† Loading embeddings model..."),"undefined"!=typeof loadUSE)try{c.embeddings=await loadUSE(),console.log("‚úÖ Embeddings model loaded")}catch(e){console.warn("‚ö†Ô∏è Embeddings model loading failed:",e.message)}return d=!0,console.log("üéâ ML models initialization completed"),c}catch(e){return console.error("‚ùå Failed to initialize ML models:",e),d=!0,c}}async function m(){try{const e=window.location.href;if(u.has(e)){const t=u.get(e);if(Date.now()-t.timestamp<l.CACHE_DURATION)return l.DEBUG_MODE&&console.log("üìã Using cached classification:",t.result),t.result.isOrder}d||await f();const t=h();let o;try{o=await async function(e){try{if(!c.distilbertClassifier)throw new Error("DistilBERT MNLI classifier not available");console.log("üß† Using DistilBERT MNLI for classification...");const t=await c.distilbertClassifier.classify(e);return console.log("ü§ñ DistilBERT MNLI Result:",{isOrder:t.isOrder,confidence:t.confidence.toFixed(3),topLabel:t.topLabel}),{isOrder:t.isOrder,confidence:t.confidence,method:"distilbert-mnli",details:t}}catch(e){throw console.error("‚ùå DistilBERT MNLI classification failed:",e.message),e}}(t)}catch(e){return console.warn("‚ö†Ô∏è ML classification unavailable, cannot proceed without ML models"),!1}u.set(e,{result:o,timestamp:Date.now()}),function(){const e=Date.now();for(const[t,o]of u.entries())e-o.timestamp>l.CACHE_DURATION&&u.delete(t)}(),l.DEBUG_MODE&&console.log("üéØ Page Classification Result:",{url:e.substring(0,100),isOrder:o.isOrder,confidence:(100*o.confidence).toFixed(1)+"%",method:o.method});const i=o.isOrder&&o.confidence>=l.CONFIDENCE_THRESHOLD;return i&&console.log(`‚úÖ Order page detected with ${(100*o.confidence).toFixed(1)}% confidence`),i}catch(e){return console.error("‚ùå Order page classification failed:",e),!1}}function h(){const e=["main",'[role="main"]',".order",".invoice",".receipt",".confirmation",".order-details",".order-summary"];let t="";for(const o of e){const e=document.querySelectorAll(o);for(const o of e)o.textContent&&(t+=o.textContent+" ")}return t.trim().length<100&&(t=document.body.textContent||""),t.substring(0,5e3)}async function g(){try{if(!await m())return console.log("‚è≠Ô∏è Not an order page, skipping extraction"),null;console.log("üì¶ Extracting order information with ML..."),d||await f();const e=h(),t=await async function(e){try{if(!c.extractor)throw new Error("Extractor model not available");console.log("üîç Starting ML-based information extraction...");const t=await fetch(`${l.MODEL_SERVER_URL}/extract`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e,url:window.location.href})});if(!t.ok)throw new Error("Extraction API error");const o=await t.json();if(c.ner){const t=await c.ner(e);o.entities=t}if(c.embeddings){const t=await c.embeddings.embed([e]);o.embeddings=await t.array()}return o.extractionMethod="ml",o.timestamp=(new Date).toISOString(),o.orderUrl=window.location.href,console.log("‚úÖ ML extraction completed:",o),o}catch(e){throw console.error("‚ùå ML extraction failed:",e),e}}(e);return t?(console.log("‚úÖ Order extracted successfully:",t),t):(console.warn("‚ö†Ô∏è No order information could be extracted"),null)}catch(e){return console.error("‚ùå Order extraction failed:",e),null}}async function p(){try{console.log("üöÄ Starting AutoComplaint ML extraction process..."),await f();const e=await g();return e?(console.log("üì¶ Successfully extracted order data:",e),"undefined"!=typeof chrome&&chrome.storage?chrome.storage.local.set({autoComplaintOrder:e},()=>{chrome.runtime.lastError?console.error("‚ùå Storage error:",chrome.runtime.lastError):console.log("‚úÖ Order data saved to storage")}):console.log("üìã Order data extracted (no storage available):",e),e):(console.log("‚ö†Ô∏è No order data could be extracted from this page"),null)}catch(e){return console.error("‚ùå Extraction process failed:",e),null}}async function w(){try{console.log("ÔøΩ Starting universal order extraction...");const e=await p();if(e){console.log("‚úÖ Universal extraction completed:",e);try{chrome.runtime.sendMessage({type:"EXTRACTION_COMPLETE",data:e,url:window.location.href})}catch(e){console.warn("‚ö†Ô∏è Could not send message to extension:",e)}}else console.log("‚ÑπÔ∏è No order data found on this page")}catch(e){console.error("‚ùå Universal extraction failed:",e)}}console.log("üèÅ AutoComplaint ML extension loaded, starting extraction..."),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",p):p(),function(){let e=window.location.href;new MutationObserver(()=>{window.location.href!==e&&(e=window.location.href,console.log("üîÑ Page URL changed, re-running extraction..."),setTimeout(p,1e3))}).observe(document.body,{subtree:!0,childList:!0})}(),"undefined"!=typeof window&&(window.AutoComplaint={extractOrderInfo:g,isOrderPage:m,initializeMLModels:f,initializeExtraction:p,models:c,CONFIG:l}),console.log("üöÄ AutoComplaint Universal Extractor v7.0 - ML-Based"),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",w):w();let E=window.location.href;new MutationObserver(()=>{window.location.href!==E&&(E=window.location.href,console.log("ÔøΩ URL changed, re-running extraction..."),setTimeout(w,1e3))}).observe(document.body,{subtree:!0,childList:!0}),"undefined"!=typeof window&&(window.AutoComplaintUniversalExtractor={startUniversalExtraction:w,lastUrl:E}),chrome.runtime.onMessage.addListener((e,t,o)=>{if("extractOrderData"===e.action)return console.log("üì• Received extraction request"),(async()=>{try{const e=await p();o({success:!0,data:e})}catch(e){console.error("‚ùå Requested extraction failed:",e),o({success:!1,error:e.message})}})(),!0})})();