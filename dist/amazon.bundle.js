(()=>{function e(e){const t={orderId:[/order\s*(?:id|number|#)\s*:?\s*([A-Z0-9\-]{10,})/gi,/(?:order|invoice)\s*#?\s*([0-9\-]{10,})/gi,/([0-9]{3}-[0-9]{7}-[0-9]{7})/g],productName:[/<title>([^|]+)/i,/product\s*name\s*:?\s*([^\n]+)/gi,/item\s*:?\s*([^\n]+)/gi],price:[/₹\s*([0-9,]+\.?[0-9]*)/g,/total\s*:?\s*₹?\s*([0-9,]+\.?[0-9]*)/gi,/amount\s*:?\s*₹?\s*([0-9,]+\.?[0-9]*)/gi],brand:[/brand\s*:?\s*([A-Za-z\s]+)/gi,/by\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)/g],orderDate:[/order\s*(?:placed|date)\s*:?\s*(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/gi,/placed\s*on\s*:?\s*(\d{1,2}\s+\w+\s+\d{4})/gi],deliveryDate:[/delivered\s*(?:on)?\s*:?\s*(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/gi,/delivery\s*date\s*:?\s*(\d{1,2}\s+\w+\s+\d{4})/gi]},o={};for(const[r,n]of Object.entries(t))for(const t of n){const n=e.match(t);if(n&&n.length>0){let a=n[0];if(t.source.includes("(")){const o=t.exec(e);o&&o[1]&&(a=o[1].trim())}o[r]=a;break}}return o}function t(){const e={};return Object.entries({orderId:['[data-testid*="order"]','[class*="order-id"]','[id*="order"]','span:contains("Order")','div:contains("Order #")'],productName:['h1[data-automation-id="product-title"]',"h1#productTitle",".product-title","h1, h2, h3"],price:[".a-price-whole",'[class*="price"]',".total-price",".amount"],brand:['[data-automation-id="brand-name"]',".brand",".manufacturer"]}).forEach(([t,o])=>{for(const r of o)try{let o;if(r.includes(":contains(")){const e=r.match(/:contains\("([^"]+)"\)/)?.[1];e&&(o=Array.from(document.querySelectorAll(r.split(":")[0])).find(t=>t.textContent.includes(e)))}else o=document.querySelector(r);if(o&&o.textContent.trim()){e[t]=o.textContent.trim();break}}catch(e){continue}}),e}async function o(){if(!function(){const e=window.location.href.toLowerCase(),t=document.title.toLowerCase(),o=document.body.innerText.toLowerCase();return["order details","order summary","order information","order number","invoice","purchase details","order id","order date","order total","your order","order confirmation","order placed","order status"].some(r=>e.includes(r)||t.includes(r)||o.includes(r))}())return void console.log("Not an order details page. Skipping extraction.");console.log("Starting enhanced multi-source extraction...");const o=function(){const e=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:function(e){const t=e.parentElement;if(!t)return NodeFilter.FILTER_REJECT;const o=window.getComputedStyle(t);return"none"===o.display||"hidden"===o.visibility||"0"===o.opacity?NodeFilter.FILTER_REJECT:e.textContent.trim()?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}});let t,o="";for(;t=e.nextNode();)o+=t.textContent+" ";return o}(),r=(document.body.innerHTML,[{method:"dom",data:t()},{method:"pattern",data:e(o+" "+document.title)},{method:"fallback",data:{productName:document.title.split("|")[0].trim(),brand:function(){const e=document.querySelector('meta[property="product:brand"]')||document.querySelector('meta[name="brand"]');return e?e.getAttribute("content"):""}(),price:function(){const e=document.querySelector('meta[property="product:price:amount"]')||document.querySelector('meta[name="price"]');return e?e.getAttribute("content"):""}()}}]),{fusedData:n,confidenceScores:a}=function(e){const t={},o={},r={dom:.8,pattern:.6,ml:.9,fallback:.3};return["orderId","productName","brand","price","orderDate","deliveryDate","sellerName","trackingNumber"].forEach(n=>{let a="",c=0,d=[];e.forEach(e=>{if(e.data[n]&&e.data[n].trim()){const t=function(e,t,o){let r=.5;switch(e){case"orderId":/^[A-Z0-9\-]{10,}$/.test(t)&&(r+=.3),t.length>=15&&(r+=.2);break;case"price":/^\d+[,.]?\d*$/.test(t.replace(/[₹$]/g,""))&&(r+=.4);break;case"productName":t.length>10&&t.length<200&&(r+=.3),/^\s*$/.test(t)||(r+=.2);break;case"brand":/^[A-Za-z\s&]+$/.test(t)&&t.length>2&&(r+=.3)}return"dom"===o&&t.includes("›")&&(r-=.1),"pattern"===o&&t.includes(":")&&(r+=.1),Math.min(r,1)}(n,e.data[n],e.method),o=t*r[e.method];d.push({method:e.method,value:e.data[n],confidence:o}),o>c&&(a=e.data[n],c=o)}}),t[n]=a,o[n]={value:a,confidence:c,sources:d}}),{fusedData:t,confidenceScores:o}}(r),c={detectedSite:window.location.hostname,orderDetailsPageUrl:window.location.href,orderId:n.orderId||"",productName:n.productName||"",brand:n.brand||"",price:n.price||"",orderDate:n.orderDate||"",deliveryDate:n.deliveryDate||"",sellerName:n.sellerName||"",trackingNumber:n.trackingNumber||"",productImage:"",productCategory:"",_fusionMetadata:{confidenceScores:a,extractionSources:r.length,overallConfidence:function(e){const t=Object.values(e).map(e=>e.confidence).filter(e=>e>0);if(0===t.length)return 0;const o=t.reduce((e,t)=>e+t,0)/t.length;return Math.round(100*o)/100}(a)}},d=Array.from(document.images).filter(e=>e.width>100&&e.height>100&&!e.src.includes("logo")&&!e.src.includes("icon"));d.length>0&&(c.productImage=d[0].src),c.productCategory=function(e){if(!e)return"Others";const t=e.toLowerCase(),o={Electronics:["phone","laptop","tablet","headphone","speaker","camera","tv"],Clothing:["shirt","t-shirt","dress","jean","trouser","jacket"],Footwear:["shoe","sandal","sneaker","boot"],"Home & Kitchen":["appliance","cookware","furniture"],Beauty:["makeup","skincare","perfume","cosmetic"],Books:["book","novel","textbook"]};for(const[e,r]of Object.entries(o))if(r.some(e=>t.includes(e)))return e;return"Others"}(c.productName),console.log("Multi-source extraction completed:",c),console.log("Fusion metadata:",c._fusionMetadata),console.log("Saving to storage with key: autoComplaintOrderUniversal");try{chrome.storage.local.set({autoComplaintOrderUniversal:c},()=>{chrome.runtime.lastError?console.error("Storage error:",chrome.runtime.lastError):(console.log("Data successfully saved to storage"),chrome.storage.local.get(["autoComplaintOrderUniversal"],e=>{console.log("Verification - data in storage:",e)}))})}catch(e){console.error("Failed to save to storage:",e)}return c}console.log("AutoComplaint: Enhanced order extraction loaded"),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",o):o();let r=window.location.href;new MutationObserver(()=>{window.location.href!==r&&(r=window.location.href,setTimeout(o,1e3))}).observe(document.body,{childList:!0,subtree:!0})})();