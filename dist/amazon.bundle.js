(()=>{console.log("AutoComplaint: Enhanced Order Extraction v3.0 - Grievance Form Optimized");class e{constructor(){this.trainedPatterns={orderId:{patterns:[/order\s*(?:id|number|#)\s*:?\s*([A-Z0-9\-]{10,})/gi,/([0-9]{3}-[0-9]{7}-[0-9]{7})/g,/order\s*#?\s*([A-Z0-9\-]+)/gi],confidence:.95},productName:{patterns:['h1[data-automation-id="product-title"]',"h1#productTitle",'[data-testid="product-title"]',".product-title","h1, h2"],textPatterns:[/item\s*:\s*(.+?)(?:\n|$)/gi,/product\s*:\s*(.+?)(?:\n|$)/gi,/title\s*:\s*(.+?)(?:\n|$)/gi],confidence:.85},productValue:{patterns:[/₹\s*([0-9,]+\.?[0-9]*)/g,/rs\.?\s*([0-9,]+\.?[0-9]*)/gi,/price\s*:?\s*₹?\s*([0-9,]+\.?[0-9]*)/gi,/total\s*:?\s*₹?\s*([0-9,]+\.?[0-9]*)/gi,/amount\s*:?\s*₹?\s*([0-9,]+\.?[0-9]*)/gi,/paid\s*:?\s*₹?\s*([0-9,]+\.?[0-9]*)/gi],domSelectors:[".a-price-whole",'[class*="price"]',".total-price",".amount",'[data-testid*="price"]',".payment-summary .total"],confidence:.9},company:{patterns:[/sold\s*by\s*:?\s*([A-Za-z\s&\.\-]+?)(?:\n|,|and|$)/gi,/seller\s*:?\s*([A-Za-z\s&\.\-]+?)(?:\n|,|and|$)/gi,/vendor\s*:?\s*([A-Za-z\s&\.\-]+?)(?:\n|,|and|$)/gi,/brand\s*:?\s*([A-Za-z\s&\.\-]+?)(?:\n|,|and|$)/gi,/manufacturer\s*:?\s*([A-Za-z\s&\.\-]+?)(?:\n|,|and|$)/gi,/by\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)/g],domSelectors:['[data-automation-id="brand-name"]',".brand",".seller-name",".manufacturer",'[class*="brand"]','[class*="seller"]','.s-size-mini a[href*="seller"]'],confidence:.8},dealerInfo:{patterns:[/seller\s*(?:contact|info|details)\s*:?\s*([^,\n]+?)(?:\n|$)/gi,/contact\s*seller\s*:?\s*([^,\n]+?)(?:\n|$)/gi,/sold\s*by\s*:?\s*([A-Za-z\s&\.\-]+)[\s,]*([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})?[\s,]*(\+?[0-9\s\-\(\)]{10,})?/gi],domSelectors:[".seller-info",".merchant-info",'[class*="seller"]',".fulfillment-message",".offer-display-feature-text"],confidence:.75},purchaseCity:{patterns:[/ship\s*(?:to|ping)\s*(?:address)?\s*:?\s*([^,\n]*?),?\s*([A-Za-z\s]+),?\s*(\d{6})/gi,/deliver\s*(?:to|y)\s*(?:address)?\s*:?\s*([^,\n]*?),?\s*([A-Za-z\s]+),?\s*(\d{6})/gi,/billing\s*(?:address)?\s*:?\s*([^,\n]*?),?\s*([A-Za-z\s]+),?\s*(\d{6})/gi,/address\s*:?\s*([^,\n]*?),?\s*([A-Za-z\s]+),?\s*(\d{6})/gi],domSelectors:[".shipping-address",".delivery-address",".billing-address",'[class*="address"]',".recipient-name + div"],confidence:.85},category:{patterns:[/category\s*:?\s*([A-Za-z\s&\-]+?)(?:\n|,|$)/gi,/department\s*:?\s*([A-Za-z\s&\-]+?)(?:\n|,|$)/gi,/product\s*type\s*:?\s*([A-Za-z\s&\-]+?)(?:\n|,|$)/gi],domSelectors:["#wayfinding-breadcrumbs_feature_div",".nav-search-dropdown",'[class*="category"]','[class*="department"]',".product-category"],confidence:.85,defaultValue:"Consumer Products"},sectorIndustry:{patterns:[/sector\s*:?\s*([A-Za-z\s&\-]+?)(?:\n|,|$)/gi,/industry\s*:?\s*([A-Za-z\s&\-]+?)(?:\n|,|$)/gi],domSelectors:[".department-heading","#nav-subnav[data-category]",'[class*="sector"]','[class*="industry"]'],confidence:.8,defaultValue:"E-commerce"},grievanceType:{patterns:[/complaint\s*type\s*:?\s*([A-Za-z\s&\-]+?)(?:\n|,|$)/gi,/issue\s*type\s*:?\s*([A-Za-z\s&\-]+?)(?:\n|,|$)/gi],defaultValue:"Grievance",confidence:1},grievanceClassification:{patterns:[/classification\s*:?\s*([A-Za-z\s&\-]+?)(?:\n|,|$)/gi,/complaint\s*category\s*:?\s*([A-Za-z\s&\-]+?)(?:\n|,|$)/gi],defaultValue:"Consumer Complaint",confidence:1},state:{patterns:[/state\s*:?\s*([A-Za-z\s&\-]+?)(?:\n|,|$)/gi,/(?:shipping|delivery|billing)\s*(?:to|address).*?,\s*([A-Za-z\s&\-]+?)\s*(?:\d{6}|\n|,|$)/gi],domSelectors:[".state",'[class*="state"]',".address-state"],confidence:.85},natureOfGrievance:{patterns:[/issue\s*description\s*:?\s*([^\n]+?)(?:\n|$)/gi,/problem\s*description\s*:?\s*([^\n]+?)(?:\n|$)/gi,/complaint\s*details\s*:?\s*([^\n]+?)(?:\n|$)/gi],domSelectors:[".problem-description",'[class*="issue"]','[class*="complaint"]'],defaultValue:"Product Quality/Service Issue",confidence:.9},dealerInfo:{patterns:[/seller\s*(?:contact|info|details)\s*:?\s*([^,\n]+?(?:[,\s]+[^,\n]+?)*)(?:\n|$)/gi,/contact\s*seller\s*:?\s*([^,\n]+?(?:[,\s]+[^,\n]+?)*)(?:\n|$)/gi,/sold\s*by\s*:?\s*([A-Za-z\s&\.\-]+)[\s,]*(?:contact\s*:)?\s*([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})?[\s,]*(\+?[0-9\s\-\(\)]{10,})?/gi,/business\s*address\s*:?\s*([^,\n]+?(?:[,\s]+[^,\n]+?)*)(?:\n|$)/gi],domSelectors:[".seller-info",".merchant-info",'[class*="seller"]',".fulfillment-message",".offer-display-feature-text","#sellerProfileTriggerId","#merchant-info"],confidence:.85},orderDate:{patterns:[/order\s*(?:placed|date)\s*:?\s*(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/gi,/placed\s*on\s*:?\s*(\d{1,2}\s+\w+\s+\d{4})/gi,/date\s*:?\s*(\d{1,2}\s+\w+\s+\d{4})/gi,/(\d{1,2}\s+(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\w*\s+\d{4})/gi],domSelectors:[".order-date",".order-info .date",'[class*="order"][class*="date"]'],confidence:.85},deliveryDate:{patterns:[/delivered\s*(?:on)?\s*:?\s*(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/gi,/delivery\s*date\s*:?\s*(\d{1,2}\s+\w+\s+\d{4})/gi,/expected\s*(?:by|on)\s*:?\s*(\d{1,2}\s+\w+\s+\d{4})/gi],confidence:.8},customerName:{patterns:[/customer\s*(?:name)?\s*:?\s*([A-Za-z\s\.]+?)(?:\n|,|$)/gi,/buyer\s*(?:name)?\s*:?\s*([A-Za-z\s\.]+?)(?:\n|,|$)/gi,/name\s*:?\s*([A-Za-z\s\.]+?)(?:\n|,|$)/gi],domSelectors:[".recipient-name",".customer-name",".buyer-name",'[class*="name"]'],confidence:.85},email:{patterns:[/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g],domSelectors:[".customer-email",".contact-email",'[type="email"]'],confidence:.9},phone:{patterns:[/(?:phone|mobile|contact)?\s*:?\s*(\+?[0-9\s\-\(\)]{10,})/gi,/(\+91[0-9\s\-]{10,})/g,/([0-9]{10})/g],domSelectors:[".phone-number",".contact-number",'[type="tel"]'],confidence:.85},orderStatus:{patterns:[/status\s*:?\s*([A-Za-z\s]+?)(?:\n|,|$)/gi,/order\s*status\s*:?\s*([A-Za-z\s]+?)(?:\n|,|$)/gi],domSelectors:[".order-status",".delivery-status",'[class*="status"]'],confidence:.8}},this.categoryMappings={Electronics:{keywords:["phone","laptop","tablet","tv","camera","headphone","speaker","electronic"],sectorIndustry:"Information Technology",grievanceCategory:"Consumer Electronics",commonIssues:["Defective Product","Warranty Issue","Quality Issue"]},Clothing:{keywords:["shirt","dress","pant","shoe","clothing","apparel","fashion","wear"],sectorIndustry:"Textile/Garments",grievanceCategory:"Fashion/Apparel",commonIssues:["Wrong Size","Quality Issue","Color Mismatch"]},Books:{keywords:["book","novel","textbook","magazine","journal","publication"],sectorIndustry:"Education/Publishing",grievanceCategory:"Educational Materials",commonIssues:["Damaged Product","Wrong Edition","Missing Pages"]},"Home & Kitchen":{keywords:["kitchen","furniture","appliance","home","decor","utensil"],sectorIndustry:"Home & Garden",grievanceCategory:"Home Appliances",commonIssues:["Defective Product","Installation Issue","Quality Issue"]},"Health & Beauty":{keywords:["cosmetic","beauty","health","medicine","supplement","skincare"],sectorIndustry:"Healthcare/Pharmaceuticals",grievanceCategory:"Health & Beauty",commonIssues:["Expired Product","Side Effects","Quality Issue"]},"Sports & Fitness":{keywords:["sports","fitness","gym","exercise","outdoor","game"],sectorIndustry:"Sports & Recreation",grievanceCategory:"Sports Equipment",commonIssues:["Quality Issue","Size Issue","Performance Issue"]},Automotive:{keywords:["car","bike","auto","vehicle","parts","accessory","automotive"],sectorIndustry:"Automotive",grievanceCategory:"Vehicle Parts",commonIssues:["Compatibility Issue","Quality Issue","Installation Problem"]}},this.locationMappings={mumbai:"Maharashtra",delhi:"Delhi",bangalore:"Karnataka",bengaluru:"Karnataka",hyderabad:"Telangana",chennai:"Tamil Nadu",kolkata:"West Bengal",pune:"Maharashtra",ahmedabad:"Gujarat",jaipur:"Rajasthan",surat:"Gujarat",lucknow:"Uttar Pradesh",kanpur:"Uttar Pradesh",nagpur:"Maharashtra",visakhapatnam:"Andhra Pradesh",indore:"Madhya Pradesh",thane:"Maharashtra",bhopal:"Madhya Pradesh",patna:"Bihar",vadodara:"Gujarat"},this.contextKeywords={orderPage:["order","invoice","receipt","purchase","transaction"],productInfo:["item","product","title","name"],pricing:["price","cost","total","amount","rupees","₹"],dates:["date","placed","delivered","expected","shipped"],contact:["email","phone","mobile","contact","address"],seller:["seller","vendor","brand","manufacturer","company"]}}detectContext(e){const t={},s=e.toLowerCase();for(const[e,a]of Object.entries(this.contextKeywords))t[e]=a.some(e=>s.includes(e));return t}calculateSmartConfidence(e,t,s,a){let r=this.trainedPatterns[e]?.confidence||.5;return"productName"===e&&s.productInfo&&(r+=.1),"price"===e&&s.pricing&&(r+=.1),"orderDate"===e&&s.dates&&(r+=.1),"orderId"===e&&/^[A-Z0-9\-]{10,}$/.test(t)&&(r+=.15),"price"===e&&/^\d+[,.]?\d*$/.test(t.replace(/[₹$]/g,""))&&(r+=.15),"productName"===e&&t.length>10&&t.length<200&&(r+=.1),"brand"===e&&/^[A-Za-z\s&]+$/.test(t)&&t.length>2&&(r+=.1),r*={dom:1,pattern:.8,hybrid:.9}[a]||.7,Math.min(r,1)}extractFromDOM(){const e={};for(const[t,s]of Object.entries(this.trainedPatterns)){if(!s.domSelectors&&!s.patterns.some(e=>"string"==typeof e))continue;const a=s.domSelectors||s.patterns.filter(e=>"string"==typeof e);for(const s of a)try{const a=document.querySelector(s);if(a&&a.textContent.trim()){e[t]=a.textContent.trim();break}}catch(e){continue}}return e}extractWithPatterns(e){const t={};for(const[s,a]of Object.entries(this.trainedPatterns)){const r=a.patterns.filter(e=>e instanceof RegExp);for(const a of r){const r=e.match(a);if(r&&r.length>0){let o=r[0];a.lastIndex=0;const n=a.exec(e);if(n&&n[1]&&(o=n[1].trim()),o=o.replace(/^[\s:]+|[\s:]+$/g,""),o&&o.length>0){t[s]=o;break}}}}return t}extractHybrid(){const e=this.getAllVisibleText(),t=this.detectContext(e),s=this.extractFromDOM(),a=this.extractWithPatterns(e+" "+document.title),r={},o=new Set([...Object.keys(s),...Object.keys(a)]);for(const e of o){const o=s[e],n=a[e];let i="",c=0;if(o){const s=this.calculateSmartConfidence(e,o,t,"dom");s>c&&(i=o,c=s)}if(n){const s=this.calculateSmartConfidence(e,n,t,"pattern");s>c&&(i=n,c=s)}i&&(r[e]=i)}return r}getAllVisibleText(){const e=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:function(e){const t=e.parentElement;if(!t)return NodeFilter.FILTER_REJECT;const s=window.getComputedStyle(t);return"none"===s.display||"hidden"===s.visibility||"0"===s.opacity?NodeFilter.FILTER_REJECT:e.textContent.trim()?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}});let t,s="";for(;t=e.nextNode();)s+=t.textContent+" ";return s}detectProductCategory(e,t=""){const s=`${e} ${t}`.toLowerCase();for(const[e,t]of Object.entries(this.categoryMappings))if(t.keywords.some(e=>s.includes(e)))return{category:e,sectorIndustry:t.sectorIndustry,grievanceCategory:t.grievanceCategory,suggestedIssues:t.commonIssues,confidence:.85};return{category:"Other",sectorIndustry:"General",grievanceCategory:"Consumer Goods",suggestedIssues:["Quality Issue","Service Issue","Billing Issue"],confidence:.5}}extractLocationInfo(e){const t=e.toLowerCase().replace(/[^\w\s]/g," ").split(/\s+/);for(const e of t)if(this.locationMappings[e])return{city:e.charAt(0).toUpperCase()+e.slice(1),state:this.locationMappings[e],confidence:.9};const s=e.match(/(\d{6})/);if(s){const e=s[1];return{pincode:e,state:this.getStateFromPincode(e),confidence:.7}}return{confidence:.3}}getStateFromPincode(e){return{1:"Delhi",2:"Haryana",3:"Punjab",4:"Rajasthan",5:"Uttar Pradesh",6:"Bihar",7:"West Bengal",8:"Odisha",9:"Kerala"}[e.charAt(0)]||"Unknown"}extractDealerInfo(e,t){const s={name:t||"Unknown",email:"",phone:"",address:""},a=e.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);a&&(s.email=a[1]);const r=e.match(/(\+?91[0-9\s\-]{10,}|[0-9]{10})/);r&&(s.phone=r[1]);const o=[/seller\s*(?:address|contact|info)\s*:?\s*([^\n]{20,100})/gi,/contact\s*seller\s*:?\s*([^\n]{20,100})/gi,/business\s*address\s*:?\s*([^\n]{20,100})/gi];for(const t of o){const a=e.match(t);if(a){s.address=a[1].trim();break}}return s}async extractOrderDetails(){const e={orderId:await this.extractField("orderId"),productName:await this.extractField("productName"),productValue:await this.extractField("productValue"),company:await this.extractField("company"),dealerInfo:await this.extractField("dealerInfo"),purchaseCity:await this.extractField("purchaseCity"),category:await this.extractField("category"),sectorIndustry:await this.extractField("sectorIndustry"),grievanceType:"Grievance",grievanceClassification:"Consumer Complaint",state:await this.extractField("state"),natureOfGrievance:await this.extractField("natureOfGrievance")};return this.postProcessDetails(e)}postProcessDetails(e){if(e.dealerInfo){const t=this.parseDealerInfo(e.dealerInfo);e.dealerInfo=this.formatDealerInfo(t)}return e.category&&(e.category=this.mapToGrievanceCategory(e.category)),e.purchaseCity&&(e.purchaseCity=this.cleanupCity(e.purchaseCity)),e.productValue&&(e.productValue=this.mapToValueRange(e.productValue)),e}parseDealerInfo(e){const t={name:"",email:"",phone:"",address:""},s=e.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/);s&&(t.email=s[0],e=e.replace(s[0],""));const a=e.match(/[\+]?[(]?[0-9]{3}[)]?[-\s\.]?[0-9]{3}[-\s\.]?[0-9]{4,6}/);a&&(t.phone=a[0],e=e.replace(a[0],""));const r=e.match(/(?:address\s*:?\s*)?([^,\n]+(?:[,\s]+[^,\n]+)*\s+\d{6})/i);return r&&(t.address=r[1].trim(),e=e.replace(r[0],"")),t.name=e.replace(/(?:sold by|seller|vendor)\s*:?\s*/i,"").trim(),t}formatDealerInfo(e){const t=[];return e.name&&t.push(e.name),e.address&&t.push(e.address),e.email&&t.push(e.email),e.phone&&t.push(e.phone),t.join(", ")}mapToGrievanceCategory(e){const t={electronics:"Electronics & Digital Goods",mobile:"Electronics & Digital Goods",computer:"Electronics & Digital Goods",clothing:"Consumer Goods",fashion:"Consumer Goods",books:"Consumer Goods",grocery:"Food & Beverages",food:"Food & Beverages",furniture:"Consumer Goods",home:"Consumer Goods",beauty:"Health & Beauty",health:"Health & Beauty",sports:"Consumer Goods",toys:"Consumer Goods",automotive:"Automotive",tools:"Consumer Goods"},s=e.toLowerCase();for(const[e,a]of Object.entries(t))if(s.includes(e))return a;return"Consumer Goods"}cleanupCity(e){return e.replace(/(?:city|district|region|area)\s*:?\s*/gi,"").replace(/^\s*,\s*/,"").replace(/[^\w\s,]/g,"").trim()}mapToValueRange(e){const t=parseFloat(e.replace(/[^\d.]/g,"")),s=[{max:1e3,label:"Below ₹1,000"},{max:5e3,label:"₹1,000 - ₹5,000"},{max:1e4,label:"₹5,000 - ₹10,000"},{max:5e4,label:"₹10,000 - ₹50,000"},{max:1e5,label:"₹50,000 - ₹1,00,000"},{max:1/0,label:"Above ₹1,00,000"}];for(const e of s)if(t<=e.max)return e.label;return"Above ₹1,00,000"}}async function t(){const t=window.location.href.toLowerCase(),s=document.title.toLowerCase(),a=document.body.innerText.toLowerCase();if(!["order details","order summary","order information","order number","invoice","purchase details","order id","order date","order total","your order","order confirmation","order placed","order status"].some(e=>t.includes(e)||s.includes(e)||a.includes(e)))return void console.log("Not an order details page. Skipping enhanced extraction.");console.log("🚀 Starting enhanced grievance-optimized extraction...");const r=new e,o=r.extractHybrid(),n=r.getAllVisibleText(),i=o.productName||"",c=o.company||o.sellerName||"",d=r.detectProductCategory(i,document.querySelector(".nav-breadcrumb")?.textContent||""),l=Array.from(document.querySelectorAll('[class*="address"], .shipping-address, .delivery-address')).map(e=>e.textContent).join(" "),u=r.extractLocationInfo(l),m=r.extractDealerInfo(n,c);let p=o.productValue||o.price||"";p&&!p.includes("₹")&&(p=p.match(/[0-9,]+\.?[0-9]*/)?.[0],p&&(p=`₹${p}`));const g={detectedSite:window.location.hostname,orderDetailsPageUrl:window.location.href,orderId:o.orderId||"",productName:i,productValue:p,company:m.name||c,dealerInfo:`${m.name}${m.email?", "+m.email:""}${m.phone?", "+m.phone:""}${m.address?", "+m.address:""}`,category:d.category,sectorIndustry:d.sectorIndustry,grievanceCategory:d.grievanceCategory,suggestedIssues:d.suggestedIssues,purchaseCity:u.city||"",state:u.state||"",pincode:u.pincode||"",customerName:o.customerName||"",email:o.email||"",phone:o.phone||"",orderDate:o.orderDate||"",deliveryDate:o.deliveryDate||"",orderStatus:o.orderStatus||"",productImage:"",trackingNumber:o.trackingNumber||"",_enhancedMetadata:{extractionMethod:"grievance-optimized-v3.0",confidence:d.confidence,locationConfidence:u.confidence,extractionTimestamp:(new Date).toISOString(),autoFillableFields:["company","productValue","dealerInfo","category","purchaseCity","sectorIndustry"],userInputRequired:["grievanceType","grievanceClassification","state","natureOfGrievance","complaintDescription"]}},h=Array.from(document.images).filter(e=>e.width>100&&e.height>100&&!e.src.includes("logo")&&!e.src.includes("icon")&&!e.src.includes("banner"));if(h.length>0){const e=h.reduce((e,t)=>t.width*t.height>e.width*e.height?t:e);g.productImage=e.src}g.productCategory=function(e){if(!e)return"Others";const t=e.toLowerCase(),s={Electronics:{keywords:["phone","laptop","tablet","headphone","speaker","camera","tv","mobile","computer","electronic"],weight:.9},Clothing:{keywords:["shirt","t-shirt","dress","jean","trouser","jacket","wear","cloth","apparel"],weight:.8},Footwear:{keywords:["shoe","sandal","sneaker","boot","footwear","slipper"],weight:.9},"Home & Kitchen":{keywords:["appliance","cookware","furniture","kitchen","home","utensil"],weight:.8},Beauty:{keywords:["makeup","skincare","perfume","cosmetic","beauty","cream"],weight:.8},Books:{keywords:["book","novel","textbook","read","literature"],weight:.9}};let a="Others",r=0;for(const[e,o]of Object.entries(s)){const s=o.keywords.filter(e=>t.includes(e)).length/o.keywords.length*o.weight;s>r&&(a=e,r=s)}return a}(g.productName),console.log("🎯 AI extraction completed:",g),console.log("🧠 AI metadata:",g._aiMetadata);try{chrome.storage.local.set({autoComplaintOrder:g},()=>{chrome.runtime.lastError?console.error("❌ Storage error:",chrome.runtime.lastError):(console.log("✅ AI-extracted data saved to storage"),chrome.storage.local.get(["autoComplaintOrder"],e=>{console.log("🔍 Verification - stored data:",e)}))})}catch(e){console.error("❌ Failed to save to storage:",e)}return g}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t):t();let s=window.location.href;new MutationObserver(()=>{window.location.href!==s&&(s=window.location.href,setTimeout(t,1500))}).observe(document.body,{childList:!0,subtree:!0})})();